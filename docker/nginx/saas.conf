# Argus SaaS — nginx reverse proxy
#
# Routes HTTP + WebSocket traffic to the API service.
# Handles connection upgrades, timeouts, and CORS.

upstream api {
    # Docker Compose DNS resolves "api" to all container IPs.
    # ip_hash provides sticky sessions so each client's WS
    # connection stays on the same API pod.
    ip_hash;
    server api:7600;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name _;

    # --- Logging ---
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    # --- Proxy defaults ---
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # --- Health check (no auth, fast path) ---
    location = /api/v1/health {
        proxy_pass http://api;
    }

    # --- WebSocket endpoint ---
    location /api/v1/ws {
        proxy_pass http://api;

        # Upgrade HTTP → WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Long-lived connections: 1 hour idle timeout
        proxy_read_timeout  3600s;
        proxy_send_timeout  3600s;

        # Disable buffering for real-time streaming
        proxy_buffering off;
    }

    # --- API routes ---
    location /api/ {
        proxy_pass http://api;

        # Standard HTTP timeouts
        proxy_read_timeout  60s;
        proxy_send_timeout  60s;

        # Allow large request bodies (ingest payloads)
        client_max_body_size 10m;
    }

    # --- Ingest endpoint (higher body limit) ---
    location /api/v1/ingest {
        proxy_pass http://api;

        client_max_body_size 50m;
        proxy_read_timeout  30s;
    }

    # --- Root / fallback ---
    location / {
        # In production, serve the static Next.js build from the API
        # container (bundled in the unified image). In dev mode, the
        # web service runs separately on port 3000.
        proxy_pass http://api;
    }
}
